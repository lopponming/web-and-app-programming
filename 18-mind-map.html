<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <style>

        body {
            font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
            min-height: 90vh;
        }

        #main {
            min-height: 90vh;
        }

        .circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background-color: darkkhaki;
            margin: 1rem;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            box-sizing: border-box;
            box-shadow: 2px 2px 8px #00000080;
        }

        div#header {
            display: grid;
            grid-template-columns: 3fr repeat(9, 1fr);
            background-color: white;
            box-shadow: 1px 1px 10px black;
        }

        .uiElem {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        #header h1 {
            margin: 2rem;
        }

        .plusButton {
            font-size: 4rem;
            font-weight: bolder;
            background-color: darksalmon;
            width: 5rem;
            height: 5rem;
            border-radius: 0.5rem;
            text-align: center;
            margin: 1.5rem;
        }

        #fontsize {
            width: 60%;
        }

        .selected {
            border: 4px solid darkcyan;
        }

        .textareaWrap  {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 90%;
            height: 90%;
        }

        .line {
            height: 5px;
            background-color: darkolivegreen;
            transform-origin: 0 100%;
        }

        /* BUTTON STYLES */
        #deleteSave {
            display: block;
            font-size:14px;
            font-family:'Courier New', Courier, monospace;
            width:122px;
            height:47px;
            border-width:2px;
            margin: 1rem;
            color:#fff;
            border-color:#314179;
            font-weight:bold;
            border-top-left-radius:9px;
            border-top-right-radius:9px;
            border-bottom-left-radius:9px;
            border-bottom-right-radius:9px;
            box-shadow:inset -3px -3px 10px 0px #7a8eb9;
            text-shadow:inset 0px 0px 0px #fff;
            background:linear-gradient(#637aad, #5972a7);
        }

        #deleteSave:hover {
            background: linear-gradient(#5972a7, #637aad);
        }



    </style>

    <link rel="stylesheet" href="jquery-ui.css">

</head>
<body>

    <div id="header">
        <div class="uiElem"><h1>mind map maker</h1></div>
        <div class="uiElem">
            <h4>add circle</h4>
            <div class="plusButton">+</div>
        </div>
        <div class="uiElem">
            <h4>change color</h4>
            <input type="color" id="color">
        </div>
        <div class="uiElem">
            <h4>change size</h4>
            <input type="range" min="50" max="1500" value="200" id="circleSize"></div>
        <div class="uiElem">
            <h4>change font size</h4>
            <input type="number" id="fontsize" value="16">
        </div>
        <div class="uiElem">
            <h4>change font color</h4>
            <input type="color" id="fontcolor">
        </div>
        <div class="uiElem">
            <button id="download">download</button></div>
        <div class="uiElem">
            <h4>open file</h4>
            <input type="file" id="jsonFile" accept="application/json">
        </div>
        <div class="uiElem"></div>
        <div class="uiElem"><button id="deleteSave">delete</button></div>
    </div>

    <div id="main">
        <div class="circle" id="c0">
            <div class="textareaWrap">
                <div class="textarea" contenteditable="false">change me</div>
            </div>  
        </div>
    </div>

    
    
    <script src="jquery-3.6.3.js"></script>
    <script src="jquery-ui.min.js"></script>

    <script>

        let newCircleID = 1;

        //LET'S CREATE A NAMED OBJECT FOR ALL THE DRAGGABLE SETTINGS TO AVOID REPETITION
        const draggableOptions = {
            start: function (event, ui){ //this method is triggered when the dragging starts
                if (event.ctrlKey){
                    $(this).addClass('cloned'); //add a class to the dragged elements
                    $(this).data('cloned', $(this).clone().removeClass('cloned'));
                    $(this).data('originalCircleID', $(this).attr('id')); //store the id of the original circle
                } else {
                    $(this).removeClass('cloned');
                }
            },
            drag: function (event, ui){ //this happens all the time when the element is being dragged
                updateLines(this);
            },
            stop: function(event, ui){ //when the dragging stops
                if ($(this).hasClass('cloned')){
                    let cloned = $(this).data('cloned');
                    $('#main').append(cloned);
                    cloned.css({
                        position: 'absolute',
                        left: ui.offset.left,
                        top: ui.offset.top
                    });
                    cloned.attr('id', 'c' + newCircleID);
                    newCircleID++;
                    cloned.draggable(draggableOptions);

                    const originalCircleID = $(this).data('originalCircleID');

                    //check if there are any lines that connect to the originalCircle
                    let allConnectedLines = $(`.line[data-circle1="${originalCircleID}"],.line[data-circle2="${originalCircleID}"]`);

                    if (allConnectedLines.length > 0){ //we don't want to do anything if there are no connected lines

                    //scoping
                    let parentCircleID;

                        allConnectedLines.each(function(index, line){
                            const connectsTo1 = $(line).data('circle1');
                            const connectsTo2 = $(line).data('circle2');

                            //assign the parentCircleID variable to the data attribute that does not match the originalCircleID, so after ? comes the value if the statement is true and after : the value we set if the statement was false
                            parentCircleID = (connectsTo1 == originalCircleID) ? connectsTo2 : connectsTo1;

                        })

                        let parentCircleElem = $('#' + parentCircleID); //selects based on a dynamic ID value

                        let selectedCircle = $(cloned);

                        let selectedCircleID = selectedCircle.attr('id');
                        let clickedCircleID = parentCircleID;

                        console.log('selectedCircleID ' + selectedCircleID + ' clickedCircleID' + clickedCircleID)

                        let selectedCircleWidth = selectedCircle[0].getBoundingClientRect().width;
                        let clickedCircleWidth = $(parentCircleElem)[0].getBoundingClientRect().width;

                        let x1pos = selectedCircle[0].getBoundingClientRect().left + selectedCircleWidth / 2; //[0] take the first element from the jQuery object and then get it's x coordinate
                        let y1pos = selectedCircle[0].getBoundingClientRect().top + clickedCircleWidth / 2;;
                        let x2pos = $(parentCircleElem)[0].getBoundingClientRect().left + clickedCircleWidth / 2;
                        let y2pos = $(parentCircleElem)[0].getBoundingClientRect().top + clickedCircleWidth / 2;

                        console.log('creating a line now, this is: ' + this);

                        createLine(x1pos, y1pos, x2pos, y2pos, selectedCircleID, parentCircleID);
                        saveToLocalStorage();

                    } //if length of lines is greater than 0

                } //end if hasClass cloned
                saveToLocalStorage();
            },
            helper: function (event){ //add a visual helper object when ctrl dragging
                if (event.ctrlKey){
                    return $(this).clone();
                } else {
                    return $(this);
                }
            }
        }

        $(document).ready(function(){
            loadFromLocalStorage();
            $('#main').draggable();
        })

        //DETECT DOUBLE CLICKS ON THE TEXTAREA DIV
        $('body').on('dblclick', '.textarea', function(){
            $(this).attr('contenteditable', 'true').focus();

            let myCircle = $(this).closest('.circle');

            if (myCircle.data('ui-draggable')){
                $(myCircle).draggable('destroy');
            }
        })

        //CHECK IF THE TEXT AREA STOPS BEING IN FOCUS
        $('body').on('blur','.textarea', function(){

            $(this).attr('contenteditable', 'false');
            $(this).closest('.circle').draggable(draggableOptions);
        saveToLocalStorage();
    })


        $('body').on('mousedown', '.textarea', function(event){
            console.log('mousdown on .textarea');
            event.stopPropagation();
        })


        //CREATE A NEW CIRCLE BY CLICKING ON THE PLUS BUTTON:
        $('.plusButton').click(function(){
            let myNewCircle = $(`<div class="circle">
                                    <div class="textareaWrap">
                                        <div class="textarea" contenteditable="false">change me</div>
                                    </div>  
                                </div>`);
                myNewCircle.attr('id', 'c'+ newCircleID);
                newCircleID++; //grow the varibale by one every time a circle is created
                $(myNewCircle).animate({
                    width: '20vw',
                    height: '20vw'
                },2000);
            $('#main').append(myNewCircle);
            $(myNewCircle).draggable(draggableOptions);
            saveToLocalStorage();

        })
        

        $('.circle').animate({
            width: '20vw',
            height: '20vw'
        },2000);

        $('.circle').draggable(draggableOptions);


        //ADD OR REMOVE THE SELECTED CLASS OF A CIRCLE WHEN IT'S CLICKED
        $('body').on('click', '.circle', function(){
            $(this).toggleClass('selected');
        });

        //ADD OR REMOVE THE SELECTED CLASS OF A LINE WHEN IT'S CLICKED
        $('body').on('click', '.line', function(){
            $(this).toggleClass('selected');
        });


        //remove selection from circles if you click on the body (on an empty area)
        $('#main').click(function(event){
            if ($(event.target).is('#main')){
                $('.circle').removeClass('selected');
                $('.line').removeClass('selected');
            }
        })

        //DETECT A SHIFT CLICK
        $('body').on('mouseup', '.circle', function(event){
            
            if (event.shiftKey){
                console.log('you clicked on a circle while holding shift down');
                let selectedCircle = $('.selected');

                let selectedCircleID = selectedCircle.attr('id');
                let clickedCircleID = $(this).attr('id');

                console.log('selectedCircleID ' + selectedCircleID + ' clickedCircleID' + clickedCircleID)

                let selectedCircleWidth = selectedCircle[0].getBoundingClientRect().width;
                let clickedCircleWidth = $(this)[0].getBoundingClientRect().width;

                let x1pos = selectedCircle[0].getBoundingClientRect().left + selectedCircleWidth / 2; //[0] take the first element from the jQuery object and then get it's x coordinate
                let y1pos = selectedCircle[0].getBoundingClientRect().top + clickedCircleWidth / 2;;
                let x2pos = $(this)[0].getBoundingClientRect().left + clickedCircleWidth / 2;
                let y2pos = $(this)[0].getBoundingClientRect().top + clickedCircleWidth / 2;

                console.log('creating a line now, this is: ' + this);

                createLine(x1pos, y1pos, x2pos, y2pos, selectedCircleID, clickedCircleID);
                saveToLocalStorage();
            }
        })

        //CREATE A LINE BETWEEN TWO ELEMENTS (USING FOUR COORDINATES)
        function createLine(x1, y1, x2, y2, selectedCircleID, clickedCircleID){

            let length = Math.sqrt(((x1 - x2) * (x1 - x2)) + ((y1 - y2) * (y1 - y2)));
            let angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
            let transform = 'rotate(' + angle + 'deg)';

            offsetX = (x1 > x2) ? x2 : x1;
            offsetY = (y1 > y2) ? y2 : y1;

            let line = $('<div>')
                        .prependTo('#main')
                        .addClass('line')
                        .css({
                            'position': 'absolute',
                            'transform': transform
                        })
                        .width(length)
                        .offset({
                            left: offsetX,
                            top: offsetY
                        })
                        .attr('data-circle1', selectedCircleID)
                        .attr('data-circle2', clickedCircleID)
        }

        //UPDATE THE LINES WHEN A CIRCLE IS MOVED
        function updateLines(circle){
            
            let allConnectedLines = $(`.line[data-circle1="${$(circle).attr('id')}"],.line[data-circle2="${$(circle).attr('id')}"]`);
            
            allConnectedLines.each(function (index, line){

                let lineCircleConnect1 = $(line).data('circle1'); //get the circle ids from the lines
                let lineCircleConnect2 = $(line).data('circle2');

                let circle1 = $('#' + lineCircleConnect1); //select the circle from dom
                let circle2 = $('#' + lineCircleConnect2); //select the circle from dom

                let x1Pos = circle1[0].getBoundingClientRect().left + circle1[0].getBoundingClientRect().width / 2;
                let y1Pos = circle1[0].getBoundingClientRect().top + circle1[0].getBoundingClientRect().height / 2;
                let x2Pos = circle2[0].getBoundingClientRect().left + circle2[0].getBoundingClientRect().width / 2;
                let y2Pos = circle2[0].getBoundingClientRect().top + circle2[0].getBoundingClientRect().height / 2;

                $(this).remove();

                createLine(x1Pos, y1Pos, x2Pos, y2Pos, circle1.attr('id'), circle2.attr('id'));

            })

        } //update lines

        //CHANGE THE COLOR OF THE SELECTED CIRCLES (BOTH OF THESE WORK)
            /* $('#color').change(function(){
                console.log($(this).val());
            }) */

        //this makes you see the color change immediately, dynamically.
        $('body').on('input', '#color', function(){
            //console.log($(this).val());

            $('.selected').css("background-color", $(this).val());
            saveToLocalStorage();

        })

        //CHANGE THE SIZE OF THE CIRCLES
        $("#circleSize").on('change input', function(){
            const scaleValueFromSlider = $(this).val();
            /* console.log("scaleValueFromSlider: " + scaleValueFromSlider); */
            $('.selected').each(function(){

                const currentWidth = $(this).outerWidth();
                //console.log(currentWidth);
                $(this).css({'width': scaleValueFromSlider, 'height': scaleValueFromSlider});

                const currentPosition = $(this).position();

                let newX = currentPosition.left - (scaleValueFromSlider - currentWidth) / 2;
                // example: 100 - (400 - 250) / 2 = 25
                let newY = currentPosition.top - (scaleValueFromSlider - currentWidth) / 2;

                $(this).css({left: newX, top: newY});

            })
            saveToLocalStorage();
        })

        // GET THE NECESSARY DATA FROM EVERY ELEMENT OF THE MIND MAP
        function extractData(){

            //loop through each circle and push the needed info as an object into an array
            let circlesData = [];
            $('.circle').each(function(){
                const circleID = $(this).attr('id');
                const circleText = $(this).find('.textarea').text();
                const circleColor = $(this).css('background-color');
                const circlePos = $(this).position();
                const circleWidth = $(this).width();
                const fontSize = $(this).find('.textarea').css('font-size');
                const fontColor = $(this).find('.textarea').css('color');
                circlesData.push({
                    id: circleID,
                    text: circleText,
                    color: circleColor,
                    position: circlePos,
                    width: circleWidth,
                    fontsize: fontSize,
                    fontcolor: fontColor
                });

            })//end circle each

            //loop through each line
            let linesData = [];
            $('.line').each(function(){
                const lineData = {
                    circle1: $(this).data('circle1'),
                    circle2: $(this).data('circle2')
                };

                linesData.push(lineData);

            });

            return {
                circles: circlesData,
                lines: linesData
            }


        } //ending extract data

        //SAVE TO STORAGE:
        function saveToLocalStorage(){
            const myData = extractData(); //store the return value of extractData into a variable called myData
            const jsonData = JSON.stringify(myData);
            localStorage.setItem('mindMapMakerData', jsonData);
            localStorage.setItem('latestID', newCircleID);
        }

        //GET THE CIRCLES AND LINES BACK FROM LOCAL STORAGE
        function loadFromLocalStorage(){
            const jsonData = localStorage.getItem('mindMapMakerData');
            if (!jsonData) return; //quit/exit the function early if there is no data yet

            const theLatestId = localStorage.getItem('latestID');
            if (!theLatestId) return;

            newCircleID = theLatestId;

            const myData = JSON.parse(jsonData);

            //clear existing elements
            $('.circle').remove();
            $('.line').remove();

            myData.circles.forEach(circleData => {
                //create a new html element for each circle
            const circle = $(`
            <div class="circle">
                <div class="textareaWrap">
                    <div class="textarea" contenteditable="false">change me</div>
                </div>  
            </div>
            `);

            circle.attr('id', circleData.id);
            circle.find('.textarea').text(circleData.text);
            circle.css('background-color', circleData.color);
            circle.css('left', circleData.position.left + 'px');
            circle.css('top', circleData.position.top + 'px');
            circle.width(circleData.width);
            circle.height(circleData.width);
            circle.find('.textarea').css({
                'font-size': circleData.fontsize,
                'color': circleData.fontcolor
            });
            $('#main').append(circle);
            $(circle).draggable(draggableOptions);

            }) //end circles for each

            // Recreate lines
            myData.lines.forEach(lineData => {
            const circle1 = $('#' + lineData.circle1);
            const circle2 = $('#' + lineData.circle2);

            const x1Pos = circle1[0].getBoundingClientRect().left + circle1[0].getBoundingClientRect().width / 2;
            const y1Pos = circle1[0].getBoundingClientRect().top + circle1[0].getBoundingClientRect().height / 2;
            const x2Pos = circle2[0].getBoundingClientRect().left + circle2[0].getBoundingClientRect().width / 2;
            const y2Pos = circle2[0].getBoundingClientRect().top + circle2[0].getBoundingClientRect().height / 2;

                createLine(x1Pos, y1Pos, x2Pos, y2Pos, circle1.attr('id'), circle2.attr('id'));
            });

        }//end load from local storage


        //DELETE LOCAL STORAGE SAVE
        $('#deleteSave').click(()=>{
            if (confirm("you really sure you wanna delete the saved mind map from storage?")){
                localStorage.removeItem('mindMapMakerData');
                localStorage.removeItem('latestID');
                window.location.reload(); //this refreshes the page
            }
        });

        //DELETE THE SELECTED CIRCLES WHEN PRESSING DELETE
        $(document).keydown(function(event){
            if (event.key === 'Delete' || event.keyCode === 46){ //two ways of checking if delete was pressed,, two pipes || mean OR
            console.log('delete key was pressed');

                $('.selected').each(function(){
                    let linesToDelete = getConnectedLines(this); //call the function, pass in the current circle and store the return value into the linesToDelete variable
                    linesToDelete.remove();
                    this.remove();
                })
            }
        })

        //GENERTIC FUNCTION FOR SELECTING THE LINES THAT CONNECT TO A SPECIFIC CIRLCE
        function getConnectedLines(circle){
            let theLines = $(`.line[data-circle1="${$(circle).attr('id')}"],.line[data-circle2="${$(circle).attr('id')}"]`);
            return theLines;
        }

        //CHANGE FONT SIZE
        $('#fontsize').change(function(){
            $('.circle.selected').find('.textarea').css('font-size', this.value + 'px');
        })

        //CHANGE FONT COLOR
        $('body').on('input', '#fontcolor', function(){
            $('.circle.selected').find('.textarea').css('color', this.value);
        })

        //DETECT CLICKS ON THE DOWNLOAD BUTTON
        $('#download').click(function(){
            const data = extractData();
            const jsonData = JSON.stringify(data);
            const myBlob = new Blob([jsonData], {type: 'application/json'});
            const myLink = document.createElement('a'); //create a new temporary link
            myLink.href = URL.createObjectURL(myBlob);
            myLink.download = 'mindmap.json';

            document.body.appendChild(myLink);
            myLink.click();
            document.body.removeChild(myLink);
        })

        //HANDLE FILE UPLOAD
        $('#jsonFile').change(function(event){
            const file = event.target.files[0];
            if (file){
                const myReader = new FileReader();
                myReader.onload = function(ev){
                    try {
                        localStorage.setItem('mindMapMakerData', ev.target.result);
                        loadFromLocalStorage();
                    } catch (error){
                        alert('the file was not right: ' + error);
                    }
                } 
                myReader.readAsText(file);
            }
        })


    </script>
    
</body>
</html>